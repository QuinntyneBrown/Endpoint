<ep-app-header [title]="request?.name || 'Request Details'">
  <div header-actions>
    @if (request) {
      <ep-button variant="secondary" size="small" (click)="onEdit()">
        <span class="material-icons">edit</span>
        Edit
      </ep-button>
      @if (request.status === 'ready' || request.status === 'completed' || request.status === 'failed') {
        <ep-button variant="primary" size="small" (click)="onExecute()">
          <span class="material-icons">play_arrow</span>
          Execute
        </ep-button>
      }
      <ep-button variant="icon" (click)="onDelete()" title="Delete">
        <span class="material-icons">delete</span>
      </ep-button>
    }
  </div>
</ep-app-header>

<main class="request-view">
  @if (loading) {
    <div class="request-view__loading">Loading...</div>
  } @else if (!request) {
    <ep-card>
      <p>Request not found</p>
    </ep-card>
  } @else {
    <ep-breadcrumb [items]="[
      { label: 'Requests', url: '/requests' },
      { label: request.name }
    ]" />

    <div class="request-view__header">
      <div>
        <h1 class="request-view__title">{{ request.name }}</h1>
        <p class="request-view__solution">{{ request.solutionName }}</p>
      </div>
      <ep-status-indicator
        [status]="getStatusType(request.status)"
        [text]="getStatusLabel(request.status)"
      />
    </div>

    @if (request.description) {
      <ep-card class="request-view__card">
        <h3 class="request-view__card-title">Description</h3>
        <p class="request-view__description">{{ request.description }}</p>
      </ep-card>
    }

    <ep-card class="request-view__card">
      <h3 class="request-view__card-title">Request Information</h3>
      <div class="request-view__info-grid">
        <div class="request-view__info-item">
          <span class="request-view__info-label">Solution Name</span>
          <span class="request-view__info-value">{{ request.solutionName }}</span>
        </div>
        <div class="request-view__info-item">
          <span class="request-view__info-label">Output Directory</span>
          <span class="request-view__info-value">{{ request.outputDirectory }}</span>
        </div>
        <div class="request-view__info-item">
          <span class="request-view__info-label">Output Type</span>
          <span class="request-view__info-value">{{ request.outputType }}</span>
        </div>
        <div class="request-view__info-item">
          <span class="request-view__info-label">Status</span>
          <span class="request-view__info-value">{{ getStatusLabel(request.status) }}</span>
        </div>
        <div class="request-view__info-item">
          <span class="request-view__info-label">Created</span>
          <span class="request-view__info-value">{{ formatDate(request.createdAt) }}</span>
        </div>
        <div class="request-view__info-item">
          <span class="request-view__info-label">Last Updated</span>
          <span class="request-view__info-value">{{ formatDate(request.updatedAt) }}</span>
        </div>
        @if (request.lastExecutedAt) {
          <div class="request-view__info-item">
            <span class="request-view__info-label">Last Executed</span>
            <span class="request-view__info-value">{{ formatDate(request.lastExecutedAt) }}</span>
          </div>
        }
      </div>
    </ep-card>

    <ep-card class="request-view__card">
      <div class="request-view__card-header">
        <h3 class="request-view__card-title">Repositories</h3>
        <ep-badge variant="neutral">{{ request.repositories.length }}</ep-badge>
      </div>

      @if (request.repositories.length === 0) {
        <div class="request-view__empty">
          <span class="material-icons">source</span>
          <p>No repositories configured</p>
        </div>
      } @else {
        <div class="request-view__repo-list">
          @for (repo of request.repositories; track repo.id) {
            <div class="request-view__repo-item">
              <div class="request-view__repo-header">
                <span class="request-view__repo-number">{{ repo.order + 1 }}</span>
                <div class="request-view__repo-info">
                  <div class="request-view__repo-url">{{ repo.url }}</div>
                  <div class="request-view__repo-meta">
                    @if (repo.branch) {
                      <div class="request-view__meta-tag">
                        <span class="material-icons">call_split</span>
                        <span>{{ repo.branch }}</span>
                      </div>
                    }
                    <div class="request-view__meta-tag">
                      <span class="material-icons">{{ repo.type === 'github' ? 'cloud' : 'folder' }}</span>
                      <span>{{ repo.type }}</span>
                    </div>
                  </div>
                </div>
              </div>

              @if (repo.folders.length > 0) {
                <div class="request-view__folders">
                  <div class="request-view__folders-header">
                    <span class="request-view__folders-label">Selected Folders</span>
                    <span class="request-view__folders-count">{{ repo.folders.length }}</span>
                  </div>
                  <div class="request-view__folders-list">
                    @for (folder of repo.folders; track folder.id) {
                      <div class="request-view__folder-chip">
                        <span class="material-icons">folder</span>
                        <span>{{ folder.path }}</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </ep-card>
  }
</main>
